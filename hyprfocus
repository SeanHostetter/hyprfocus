#!/usr/bin/env bash
# hyprfocus - Hyprland workspace switcher with thumbnail grid
# Uses rofi for grid display of workspace thumbnails

# === DIRECTORIES ===
CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/hyprfocus"
CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/hyprfocus"
CONFIG_FILE="$CONFIG_DIR/config"
KITTY_THEME="${HOME}/.config/omarchy/current/theme/kitty.conf"

# === DEFAULT CONFIG ===
CAPTURE_ENABLED=true
THUMB_SCALE=0.15
GRID_COLUMNS=3
GRID_ROWS=2
ICON_SIZE=200
WINDOW_WIDTH=70
WINDOW_HEIGHT=60
USE_KITTY_THEME=true

# === LOAD USER CONFIG ===
mkdir -p "$CACHE_DIR" "$CONFIG_DIR"
[[ -f "$CONFIG_FILE" ]] && source "$CONFIG_FILE"

# === DEBUG ===
DEBUG="${HYPRFOCUS_DEBUG:-0}"
debug() { [[ "$DEBUG" == "1" ]] && echo "[DEBUG] $*" >&2; }

# === DEPENDENCIES ===
check_deps() {
    local missing=()
    for cmd in hyprctl rofi jq grim; do
        command -v "$cmd" &>/dev/null || missing+=("$cmd")
    done
    
    if [[ ${#missing[@]} -gt 0 ]]; then
        echo "Error: Missing: ${missing[*]}" >&2
        exit 1
    fi
}

# === WORKSPACE FUNCTIONS ===
get_workspace_ids() {
    hyprctl workspaces -j | jq -r 'sort_by(.id) | .[].id'
}

get_active_workspace() {
    hyprctl activeworkspace -j | jq -r '.id'
}

get_focused_monitor() {
    hyprctl monitors -j | jq -r '.[] | select(.focused) | .name'
}

# === CAPTURE ===
capture_workspace() {
    local ws_id="$1"
    local monitor
    monitor=$(get_focused_monitor)
    grim -o "$monitor" -s "$THUMB_SCALE" "$CACHE_DIR/workspace-$ws_id.png" 2>/dev/null || true
}

capture_current() {
    capture_workspace "$(get_active_workspace)"
}

capture_all() {
    local current_ws
    current_ws=$(get_active_workspace)
    
    for ws_id in $(get_workspace_ids); do
        hyprctl dispatch workspace "$ws_id" >/dev/null 2>&1
        sleep 0.05
        capture_workspace "$ws_id"
    done
    
    hyprctl dispatch workspace "$current_ws" >/dev/null 2>&1
}

get_thumbnail() {
    local thumb="$CACHE_DIR/workspace-$1.png"
    [[ -f "$thumb" ]] && echo "$thumb"
}

# === THEMING ===
get_kitty_color() {
    local key="$1"
    local default="$2"
    if [[ "$USE_KITTY_THEME" == "true" && -f "$KITTY_THEME" ]]; then
        local val
        val=$(grep -E "^${key}\s+" "$KITTY_THEME" | awk '{print $2}' | head -1)
        [[ -n "$val" ]] && echo "$val" && return
    fi
    echo "$default"
}

create_rofi_theme() {
    local bg fg accent accent_alt
    bg=$(get_kitty_color "background" "#1e1e2e")
    fg=$(get_kitty_color "foreground" "#cdd6f4")
    accent=$(get_kitty_color "color4" "#89b4fa")
    accent_alt=$(get_kitty_color "color8" "#313244")
    
    debug "Theme: bg=$bg fg=$fg columns=$GRID_COLUMNS rows=$GRID_ROWS"
    
    cat > "$CONFIG_DIR/grid.rasi" << THEME
* {
    background:     ${bg}ee;
    background-alt: ${bg};
    foreground:     ${fg};
    selected:       ${accent};
    font: "monospace 12";
}

window {
    width:            ${WINDOW_WIDTH}%;
    height:           ${WINDOW_HEIGHT}%;
    background-color: @background;
    border:           2px;
    border-color:     @selected;
    border-radius:    12px;
    padding:          15px;
}

mainbox {
    children: [listview];
    background-color: transparent;
}

listview {
    columns:          ${GRID_COLUMNS};
    lines:            ${GRID_ROWS};
    flow:             horizontal;
    cycle:            true;
    scrollbar:        false;
    spacing:          8px;
    background-color: transparent;
}

element {
    orientation:      vertical;
    padding:          8px;
    border-radius:    8px;
    background-color: @background-alt;
}

element selected {
    border:           3px;
    border-color:     @selected;
    background-color: @background-alt;
}

element-icon {
    size:             ${ICON_SIZE}px;
    horizontal-align: 0.5;
    border-radius:    4px;
    background-color: transparent;
}

element-text {
    horizontal-align: 0.5;
    padding:          4px 0 0 0;
    text-color:       @foreground;
    background-color: transparent;
}
THEME
}

# === ROFI SELECTOR ===
run_selector() {
    # Toggle: if rofi running, kill it
    if pgrep -x rofi >/dev/null 2>&1; then
        pkill -x rofi
        return 0
    fi
    
    debug "Starting selector"
    
    local active_ws
    active_ws=$(get_active_workspace)
    debug "Active workspace: $active_ws"
    
    create_rofi_theme
    
    # Calculate selected row
    local selected_idx=0 idx=0
    for ws in $(get_workspace_ids); do
        [[ "$ws" == "$active_ws" ]] && selected_idx=$idx && break
        ((idx++))
    done
    debug "Selected index: $selected_idx"
    
    # Build entries and pipe to rofi
    local selected
    selected=$(
        for ws_id in $(get_workspace_ids); do
            local thumb
            thumb=$(get_thumbnail "$ws_id")
            if [[ -n "$thumb" ]]; then
                echo -en "${ws_id}\0icon\x1f${thumb}\n"
            else
                echo "$ws_id"
            fi
        done | rofi -dmenu \
            -theme "$CONFIG_DIR/grid.rasi" \
            -show-icons \
            -normal-window \
            -kb-row-up "Up,k" \
            -kb-row-down "Down,j" \
            -kb-row-left "h" \
            -kb-row-right "l" \
            -kb-custom-1 "space" \
            -kb-cancel "Escape,q" \
            -selected-row "$selected_idx" \
            -p "" 2>/dev/null
    )
    local exit_code=$?
    debug "Exit: $exit_code, selected: '$selected'"
    
    # Handle result
    if [[ $exit_code -eq 10 ]]; then
        # Space: create new workspace
        local max_ws=0
        for ws in $(get_workspace_ids); do
            [[ $ws -gt $max_ws ]] && max_ws=$ws
        done
        local new_ws=$((max_ws + 1))
        debug "Creating workspace $new_ws"
        hyprctl dispatch workspace "$new_ws"
    elif [[ $exit_code -eq 0 && -n "$selected" && "$selected" =~ ^[0-9]+$ ]]; then
        hyprctl dispatch workspace "$selected"
    fi
}

# === CONFIG MANAGEMENT ===
init_config() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        local script_dir
        script_dir="$(dirname "$(readlink -f "$0")")"
        if [[ -f "$script_dir/config.default" ]]; then
            cp "$script_dir/config.default" "$CONFIG_FILE"
        else
            cat > "$CONFIG_FILE" << 'EOF'
# hyprfocus config - see README for options
CAPTURE_ENABLED=true
THUMB_SCALE=0.15
PERIODIC_INTERVAL=7
GRID_COLUMNS=3
GRID_ROWS=2
ICON_SIZE=200
WINDOW_WIDTH=70
WINDOW_HEIGHT=60
USE_KITTY_THEME=true
EOF
        fi
        echo "Created config: $CONFIG_FILE"
    else
        echo "Config exists: $CONFIG_FILE"
    fi
}

# === MAIN ===
case "${1:-}" in
    --capture)
        capture_current
        echo "Captured workspace $(get_active_workspace)"
        ;;
    --capture-all)
        echo "Capturing all workspaces..."
        capture_all
        echo "Done"
        ;;
    --refresh)
        rm -f "$CACHE_DIR"/workspace-*.png
        capture_all
        ;;
    --config)
        init_config
        ;;
    --edit-config)
        init_config >/dev/null
        ${EDITOR:-nano} "$CONFIG_FILE"
        ;;
    --debug)
        export HYPRFOCUS_DEBUG=1
        check_deps
        run_selector
        ;;
    --check)
        check_deps
        echo "OK"
        ;;
    --help|-h)
        echo "hyprfocus - Workspace switcher with thumbnails"
        echo ""
        echo "Usage: hyprfocus [OPTION]"
        echo ""
        echo "Options:"
        echo "  (none)        Open workspace switcher"
        echo "  --capture     Capture current workspace"
        echo "  --refresh     Refresh all thumbnails"
        echo "  --config      Create/show config file"
        echo "  --edit-config Edit config file"
        echo "  --debug       Run with debug output"
        echo "  --help        Show this help"
        echo ""
        echo "Config: $CONFIG_FILE"
        ;;
    *)
        check_deps
        run_selector
        ;;
esac
